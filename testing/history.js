var json = {  
   "docs":[  
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:50:17.731Z",
         "game":"pick-twenty",
         "gamepack":"default",
         "locale":"en",
         "ident":"pick-twenty:default:en:N=5,rotateGoals=true",
         "hash":-773536409,
         "eventType":"gameFinished",
         "settings":{  
            "N":5,
            "rotateGoals":true
         },
         "eventData":{  
            "totalTime":4200,
            "mistakes":0
         },
         "eventData2":{  
            "totalTime":4200,
            "mistakes":0
         },
         "eventData3":[  
            "Total time: 4.2 sec",
            "Mistakes total: 0"
         ],
         "_id":"2017-07-03T21:50:17.731Z",
         "_rev":"1-acaa899cfe187522a14ec66fd4f90f0f"
      },
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:50:03.614Z",
         "game":"mental-rotation",
         "gamepack":"default",
         "locale":"en",
         "ident":"mental-rotation:default:en:",
         "hash":1240507200,
         "eventType":"gameFinished",
         "settings":{  

         },
         "eventData":[  
            true,
            false,
            false
         ],
         "eventData2":{  
            "correct":false,
            "correctness":0.3333333333333333,
            "answeredTotal":3,
            "answeredCorrectly":1,
            "correctAnswers":[  
               1,
               0,
               0
            ]
         },
         "eventData3":[  
            "Correctness: 33.3%"
         ],
         "_id":"2017-07-03T21:50:03.614Z",
         "_rev":"1-4eed7c7a30884902388c3ecff8e09cad"
      },
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:49:54.566Z",
         "game":"mental-rotation",
         "gamepack":"default",
         "locale":"en",
         "ident":"mental-rotation:default:en:",
         "hash":1240507200,
         "eventType":"gameFinished",
         "settings":{  

         },
         "eventData":[  
            true,
            false,
            false
         ],
         "eventData2":{  
            "correct":false,
            "correctness":0.3333333333333333,
            "answeredTotal":3,
            "answeredCorrectly":1,
            "correctAnswers":[  
               1,
               0,
               0
            ]
         },
         "eventData3":[  
            "Correctness: 33.3%"
         ],
         "_id":"2017-07-03T21:49:54.566Z",
         "_rev":"1-45973664de8ddc842b6fc6a4958e8818"
      },
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:49:42.596Z",
         "game":"combine-words",
         "gamepack":"english",
         "locale":"en",
         "ident":"combine-words:english:en:",
         "hash":-112644024,
         "eventType":"gameFinished",
         "settings":{  

         },
         "eventData":[  
            1,
            3,
            0,
            4,
            5,
            2
         ],
         "eventData2":{  
            "correct":false,
            "correctness":0,
            "answeredTotal":6,
            "answeredCorrectly":0,
            "correctAnswers":[  
               0,
               0,
               0,
               0,
               0,
               0
            ]
         },
         "eventData3":[  
            "Correctness: 0.0%",
            "Total time: 9.96 s"
         ],
         "_id":"2017-07-03T21:49:42.596Z",
         "_rev":"1-3a34f497c086333bdeaeff761a7b75d1"
      },
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:49:27.032Z",
         "game":"pick-twenty",
         "gamepack":"default",
         "locale":"en",
         "ident":"pick-twenty:default:en:N=10,rotateGoals=true",
         "hash":1906915049,
         "eventType":"gameFinished",
         "settings":{  
            "N":10,
            "rotateGoals":true
         },
         "eventData":{  
            "totalTime":10300,
            "mistakes":0
         },
         "eventData2":{  
            "totalTime":10300,
            "mistakes":0
         },
         "eventData3":[  
            "Total time: 10.3 sec",
            "Mistakes total: 0"
         ],
         "_id":"2017-07-03T21:49:27.032Z",
         "_rev":"1-17cd9b9b7dff7f60adfd93842eba8e99"
      },
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:49:08.220Z",
         "game":"colortest-reverse",
         "gamepack":"default",
         "locale":"en",
         "ident":"colortest-reverse:default:en:N=10,matchProbability=35",
         "hash":-1730983527,
         "eventType":"gameFinished",
         "settings":{  
            "N":10,
            "matchProbability":35
         },
         "eventData":[  
            false,
            false,
            true,
            false,
            false,
            false,
            false,
            false,
            false,
            false
         ],
         "eventData2":{  
            "correct":false,
            "correctness":0.1,
            "answeredTotal":10,
            "answeredCorrectly":1,
            "correctAnswers":[  
               0,
               0,
               1,
               0,
               0,
               0,
               0,
               0,
               0,
               0
            ]
         },
         "eventData3":[  
            "Correctness: 10.0%",
            "Total time: 9.04 s",
            "Minimum reaction time: 0.32 s",
            "Average reaction time: 0.39 s"
         ],
         "_id":"2017-07-03T21:49:08.220Z",
         "_rev":"1-66f712cb90a0c8dd90f7fecce3e2139d"
      },
      {  
         "$type":"game-event",
         "usertoken":"7505d64a54e061b7acd54ccd58b49dc43500b635",
         "timestamp":"2017-07-03T21:47:53.557Z",
         "game":"pick-twenty",
         "gamepack":"default",
         "locale":"en",
         "ident":"pick-twenty:default:en:N=10,rotateGoals=true",
         "hash":1906915049,
         "eventType":"gameFinished",
         "settings":{  
            "N":10,
            "rotateGoals":true
         },
         "eventData":{  
            "totalTime":14100,
            "mistakes":2
         },
         "eventData2":{  
            "totalTime":14100,
            "mistakes":2
         },
         "eventData3":[  
            "Total time: 14.1 sec",
            "Mistakes total: 2"
         ],
         "_id":"2017-07-03T21:47:53.557Z",
         "_rev":"1-75f01fc3ad7977162d8f4ad16b02c47c"
      }
   ]
}
;

var makeGameTitle = function(gameTitle) {
	return $("<span>").addClass("gametitle").text(gameTitle);
}

var makeGamepackTitle = function(gamepackTitle) {
	return $("<span>").addClass("gamepacktitle").text(gamepackTitle);
}

var makeLocaleWidget = function(locale) {
	return $("<span>").text(locale);
}

var makeSettingsWidget = function(settings) {
	var si = [];
  for(s in settings) {
  	si.push(s + "=" + settings[s]);
  }
	return $("<div>").addClass("gamesettings").text(si.join(", "));
}

var makeGameItem = function(rec) {
  var game = rec.game;
  var gamepack = rec.gamepack;
  var locale = rec.locale;
  var ident = rec.ident;
  var settings = rec.settings;
	return $("<div>").addClass("gameitem").append(
    $("<div>").addClass("gametitlebar").append(
  	  makeGameTitle(game),
      makeGamepackTitle(gamepack),
      makeLocaleWidget(locale)
    ),
    makeSettingsWidget(settings)
  );
}

var makeDateTime = function(date, time) {
	return $("<div>").addClass("datetime").append(
    $("<div>").addClass("gamedate").text(date),
    $("<div>").addClass("gametime").text(time)
  );
}

var makeResults = function(results) {
  var res = $("<div>").addClass("gameresults");
	var rr = [];
  results.forEach(function(r) {
    if(typeof(r) == "string") {
      var parts = r.split(":");
      if(parts.length == 2) {
      	var label = parts[0];
        var value = parts[1];
        rr.push({"label": label, "value": value});
      }
    }
  });
  rr.forEach(function(r) {
        console.log(r.label, r.value);
        res.append(
        	$("<div>").addClass("gameresult").append(
          	$("<div>").addClass("gamelabel").text(r.label),
            $("<div>").addClass("gamevalue").text(r.value)
          )
        );
  });
  return res;
}

//var locale = "en-US";
var loc = "cs-CZ";

var records = json.docs || [];

// group records by ident
var idents = [];
var identMap = {};
records.forEach(function(r) {
	if(r.ident in identMap) {
  	identMap[r.ident].push(r);
  } else {
  	idents.push(r.ident);
    identMap[r.ident] = [r];
  }
});


var out = $("<div>").addClass("output").appendTo($("body"));
idents.forEach(function(ident) {
  var records = identMap[ident];
  var first = records[0];
  var gi = $("<div>").addClass("gametopitem").appendTo(out);
  var el = makeGameItem(first);
  gi.append(el);
  records.forEach(function(r) {
    var ts = r.timestamp;
    var dt = new Date(ts);
    var date = dt.toLocaleDateString(loc);
    var time = dt.toLocaleTimeString(loc, {hour: '2-digit', minute:'2-digit', second: '2-digit'});
    var result = r.eventData3 || [];
  	console.log("Rec:", date, time, result);
    var el1 = makeDateTime(date, time);
    var el2 = makeResults(result);
    gi.append($("<div>").addClass("gamerecord").append(el1, el2));
  });
})
